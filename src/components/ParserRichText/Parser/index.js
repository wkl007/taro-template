// 小程序富文本插件 https://github.com/jin-yufeng/Parser
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},parseHtmlSync=require("./libs/MpHtmlParser.js").parseHtmlSync,cache=getApp().parserCache={},CssHandler=require("./libs/CssHandler.js"),config=require("./libs/config.js"),document;try{document=require("./libs/document.js")}catch(t){}var Hash=function(t){for(var e=0,r=5381,n=t.length;e<n;e++)r+=(r<<5)+t.charCodeAt(e);return r},hideAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(0).step().export(),showAnimation=wx.createAnimation({timingFunction:"ease"}).opacity(1).step().export(),Deduplication=function(t){if(0!=t.indexOf("http"))return t;for(var e="",r=0;r<t.length&&(e+=Math.random()>=.5?t[r].toUpperCase():t[r].toLowerCase(),"/"!=t[r]||"/"==t[r-1]||"/"==t[r+1]);r++);return e+=t.substring(r+1)};Component({properties:{html:{type:null,value:null,observer:function(t){if(this._refresh)return this._refresh=!1;this.setContent(t,void 0,!0)}},autocopy:{type:Boolean,value:!0},autopause:{type:Boolean,value:!0},autopreview:{type:Boolean,value:!0},autosetTitle:{type:Boolean,value:!0},domain:{type:String,value:null},imgMode:{type:String,value:"default"},lazyLoad:{type:Boolean,value:!1},selectable:{type:Boolean,value:!1},tagStyle:{type:Object,value:{}},showWithAnimation:{type:Boolean,value:!1},useAnchor:{type:Boolean,value:!1},useCache:{type:Boolean,value:!1}},created:function(){var t=this;this.navigateTo=function(e){var r=t.createSelectorQuery();r.select("#contain"+(e.id?">>>#"+e.id:"")).boundingClientRect(),r.selectViewport().scrollOffset(),r.exec(function(t){if(!t||!t[0])return e.fail?e.fail({errMsg:"Label Not Found"}):null;wx.pageScrollTo({scrollTop:t[1].scrollTop+t[0].top,success:e.success,fail:e.fail})})},this.getText=function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r="";if(!t.data.html||!t.data.html.length)return"";var n=!0,a=!1,o=void 0;try{for(var i,l=t.data.html[Symbol.iterator]();!(n=(i=l.next()).done);n=!0){var s=i.value;!function t(n){if("text"==n.type)return r+=n.text;e&&(("p"==n.name||"div"==n.name||"tr"==n.name||"li"==n.name||/h[1-6]/.test(n.name))&&r&&"\n"!=r[r.length-1]||"br"==n.name)&&(r+="\n");var a=!0,o=!1,i=void 0;try{for(var l,s=(n.children||[])[Symbol.iterator]();!(a=(l=s.next()).done);a=!0){t(l.value)}}catch(t){o=!0,i=t}finally{try{!a&&s.return&&s.return()}finally{if(o)throw i}}e&&("p"==n.name||"div"==n.name||"tr"==n.name||"li"==n.name||/h[1-6]/.test(n.name))&&r&&"\n"!=r[r.length-1]?r+="\n":e&&"td"==n.name&&(r+="\t")}(s)}}catch(t){a=!0,o=t}finally{try{!n&&l.return&&l.return()}finally{if(a)throw o}}return r},this.getVideoContext=function(e){if(!e)return t.videoContexts;var r=!0,n=!1,a=void 0;try{for(var o,i=t.videoContexts[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var l=o.value;if(l.id==e)return l}}catch(t){n=!0,a=t}finally{try{!r&&i.return&&i.return()}finally{if(n)throw a}}return null},this.imgList=[],this.imgList.each=function(t){for(var e=0;e<this.length;e++){var r=t(this[e],e,this);r&&(this.includes(r)?this[e]=Deduplication(r):this[e]=r)}},this._refresh=!1,this.setContent=function(e,r,n){if("object"==(void 0===r?"undefined":_typeof(r)))for(var a in r)a=a.replace(/-(\w)/g,function(){return arguments[1].toUpperCase()}),t.data[a]=r[a];var o={controls:{imgMode:t.data.imgMode}};if(t.data.showWithAnimation&&(o.showAnimation=showAnimation,o.hideAnimation=hideAnimation),e)if("string"==typeof e){var i;if(t.data.useCache){var l=Hash(e);cache[l]?i=cache[l]:(i=parseHtmlSync(e,t.data),cache[l]=i)}else i=parseHtmlSync(e,t.data);o.html=i,t.triggerEvent("parse",i)}else if(e.constructor==Array){if(e.length&&"Parser"!=e[0].PoweredBy){var s={_imgNum:0,_videoNum:0,_audioNum:0,_domain:t.data.domain,_protocol:t.data.domain?t.data.domain.includes("://")?t.data.domain.split("://")[0]:"http":void 0,_STACK:[],CssHandler:new CssHandler(t.data.tagStyle)};s.CssHandler.getStyle("");!function t(e){var r=!0,n=!1,a=void 0;try{for(var o,i=e[Symbol.iterator]();!(r=(o=i.next()).done);r=!0){var l=o.value;if("text"!=l.type){l.attrs=l.attrs||{};for(var c in l.attrs)config.trustAttrs[c]?"string"!=typeof l.attrs[c]&&(l.attrs[c]=l.attrs[c].toString()):l.attrs[c]=void 0;config.LabelAttrsHandler(l,s),config.blockTags[l.name]?l.name="div":config.trustTags[l.name]||(l.name="span"),l.children&&l.children.length?(s._STACK.push(l),t(l.children),s._STACK.pop()):l.children=void 0}}}catch(t){n=!0,a=t}finally{try{!r&&i.return&&i.return()}finally{if(n)throw a}}}(e),o.html=e}n||(o.html=e)}else{if("object"!=(void 0===e?"undefined":_typeof(e))||!e.nodes)return t.triggerEvent("error",{source:"parse",errMsg:"错误的html类型："+(void 0===e?"undefined":_typeof(e))});o.html=e.nodes,console.warn("Parser 类型错误：object 类型已废弃，请直接将 html 设置为 object.nodes （array 类型）")}else{if(n)return;o.html=""}t._refresh=!!o.html,t.setData(o),t.imgList.length=0,t.videoContexts=[],document&&(t.document=new document("html",o.html||e,t));var c=[t.selectComponent("#contain")].concat(t.selectAllComponents("#contain>>>._node")),u=!0,d=!1,f=void 0;try{for(var m,v=c[Symbol.iterator]();!(u=(m=v.next()).done);u=!0){var h=m.value;h._top=t;var y=!0,p=!1,g=void 0;try{for(var b,x=h.data.nodes[Symbol.iterator]();!(y=(b=x.next()).done);y=!0){var w=b.value;if(!w.continue)if("img"==w.name)w.attrs.src&&w.attrs.i&&(-1==t.imgList.indexOf(w.attrs.src)?t.imgList[w.attrs.i]=w.attrs.src:t.imgList[w.attrs.i]=Deduplication(w.attrs.src));else if("video"==w.name){var C=wx.createVideoContext(w.attrs.id,h);C.id=w.attrs.id,t.videoContexts.push(C)}else"audio"==w.name&&w.attrs.autoplay?wx.createAudioContext(w.attrs.id,h).play():"title"==w.name&&"text"==w.children[0].type&&w.children[0].text&&t.data.autosetTitle&&wx.setNavigationBarTitle({title:w.children[0].text})}}catch(t){p=!0,g=t}finally{try{!y&&x.return&&x.return()}finally{if(p)throw g}}h.data.imgLoad&&h.setData({imgLoad:!1})}}catch(t){d=!0,f=t}finally{try{!u&&v.return&&v.return()}finally{if(d)throw f}}(wx.nextTick||setTimeout)(function(){var e=!0,r=!1,n=void 0;try{for(var a,o=c[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var i;!function(){var e=a.value,r=!0,n=!1,o=void 0;try{for(var l,s=e.data.nodes[Symbol.iterator]();!(r=(l=s.next()).done);r=!0)if(i=l.value,"img"==i.name){t.data.lazyLoad&&e.createIntersectionObserver?(e._observer&&e._observer.disconnect(),e._observer=e.createIntersectionObserver(),e._observer.relativeToViewport({top:1e3,bottom:1e3}).observe(".img",function(t){e.setData({imgLoad:!0}),e._observer.disconnect(),e._observer=null})):e.setData({imgLoad:!0});break}}catch(t){n=!0,o=t}finally{try{!r&&s.return&&s.return()}finally{if(n)throw o}}}()}}catch(t){r=!0,n=t}finally{try{!e&&o.return&&o.return()}finally{if(r)throw n}}t.createSelectorQuery().select("#contain").boundingClientRect(function(e){t.triggerEvent("ready",e)}).exec()},50)}}});